<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arthurian Scout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root {
      --bg-main: #050508;
      --bg-secondary: #0a0a0f;
      --bg-card: rgba(20, 20, 30, 0.6);
      --bg-card-hover: rgba(30, 30, 45, 0.8);
      --accent: #7C3AED;
      --accent-light: #A78BFA;
      --success: #10B981;
      --success-glow: rgba(16, 185, 129, 0.3);
      --warning: #F59E0B;
      --error: #EF4444;
      --purple: #8B5CF6;
      --text-main: #F8FAFC;
      --text-muted: #94A3B8;
      --border: rgba(255,255,255,0.06);
      --glow: 0 0 40px rgba(124, 58, 237, 0.15);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-main);
      background-image:
        radial-gradient(ellipse at top, rgba(124, 58, 237, 0.08) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(139, 92, 246, 0.05) 0%, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* Header */
    header {
      background: rgba(5, 5, 8, 0.85);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .brand-icon {
      width: 42px; height: 42px;
      background: linear-gradient(135deg, #7C3AED 0%, #EC4899 50%, #F59E0B 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4);
      animation: pulse-glow 3s ease-in-out infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(236, 72, 153, 0.5); }
    }
    .brand h1 {
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, #fff 0%, #A78BFA 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 500;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
    }
    .btn:hover {
      background: rgba(255,255,255,0.08);
      color: var(--text-main);
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .btn:active { transform: scale(0.97) translateY(0); }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #9333EA 100%);
      border: none;
      color: white;
      box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
    }
    .btn-primary:hover {
      box-shadow: 0 6px 25px rgba(124, 58, 237, 0.45);
      transform: translateY(-2px);
    }
    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      border: none;
      color: white;
      box-shadow: 0 4px 15px var(--success-glow);
    }
    .btn.active {
      background: linear-gradient(135deg, rgba(16,185,129,0.2), rgba(16,185,129,0.1));
      color: var(--success);
      border-color: rgba(16,185,129,0.4);
      box-shadow: 0 0 20px var(--success-glow);
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.75rem;
      border-radius: 8px;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 32px;
      padding: 24px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(10, 10, 15, 0.5);
      backdrop-filter: blur(10px);
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    .stat:hover {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.1);
    }
    .stat-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      box-shadow: 0 0 10px currentColor;
    }
    .stat-dot.pending { background: var(--text-muted); box-shadow: none; }
    .stat-dot.available { background: var(--success); }
    .stat-dot.unavailable { background: var(--error); }
    .stat-dot.dm-sent { background: var(--purple); }
    .stat-label { color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-weight: 700; font-size: 1.3rem; background: linear-gradient(135deg, #fff, #A78BFA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    /* Main Content */
    main {
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Creator Grid */
    .creator-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    /* Creator Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    .card:hover {
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), var(--glow);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 3px; height: 100%;
      background: var(--text-muted);
      transition: all 0.3s;
    }
    .card:hover::before {
      width: 4px;
    }
    .card.pending::before { background: linear-gradient(180deg, var(--text-muted), #64748B); }
    .card.available::before { background: linear-gradient(180deg, var(--success), #059669); box-shadow: 0 0 15px var(--success-glow); }
    .card.available {
      border-color: rgba(16,185,129,0.2);
      background: linear-gradient(135deg, rgba(16,185,129,0.08) 0%, var(--bg-card) 100%);
    }
    .card.available:hover {
      border-color: rgba(16,185,129,0.4);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 30px var(--success-glow);
    }
    .card.unavailable::before { background: linear-gradient(180deg, var(--error), #DC2626); }
    .card.unavailable { opacity: 0.6; }
    .card.unavailable:hover { opacity: 0.8; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .card-id {
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-id:hover { color: var(--accent); }
    .card-id .material-symbols-rounded {
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .card-id:hover .material-symbols-rounded { opacity: 1; }

    .card-status {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .card-status.pending {
      background: rgba(156,163,175,0.15);
      color: var(--text-muted);
    }
    .card-status.available {
      background: rgba(16,185,129,0.15);
      color: var(--success);
    }
    .card-status.unavailable {
      background: rgba(239,68,68,0.15);
      color: var(--error);
    }

    .card-reason {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 100px 20px;
      color: var(--text-muted);
    }
    .empty-state .material-symbols-rounded {
      font-size: 80px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, var(--accent-light) 0%, var(--text-muted) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      opacity: 0.6;
    }
    .empty-state p {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--text-main);
      opacity: 0.8;
    }
    .empty-state small {
      opacity: 0.5;
      font-size: 0.9rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, rgba(30, 30, 45, 0.95), rgba(20, 20, 30, 0.98));
      color: white;
      padding: 14px 28px;
      border-radius: 16px;
      font-size: 0.9rem;
      font-weight: 500;
      box-shadow: 0 15px 40px rgba(0,0,0,0.4), 0 0 30px rgba(124, 58, 237, 0.15);
      z-index: 1000;
      animation: toastSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    @keyframes toastSlide {
      from { opacity: 0; transform: translate(-50%, 30px) scale(0.95); }
      to { opacity: 1; transform: translate(-50%, 0) scale(1); }
    }

    /* Loading Spinner */
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.02);
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Card Nickname */
    .card-nickname {
      font-size: 0.9rem;
      color: var(--accent-light);
      margin-bottom: 10px;
      font-weight: 500;
    }

    /* Action Button Styles */
    .btn-dm {
      background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
      border: none;
      color: white;
      box-shadow: 0 3px 12px rgba(139, 92, 246, 0.3);
    }
    .btn-dm:hover {
      box-shadow: 0 5px 20px rgba(139, 92, 246, 0.45);
      transform: translateY(-1px);
    }
    .btn-dm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Shine animation for available cards */
    .card.available::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(16,185,129,0.05), transparent);
      animation: shine 4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shine {
      0%, 100% { left: -100%; }
      50% { left: 150%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-icon">
        <span class="material-symbols-rounded" style="color:white">radar</span>
      </div>
      <h1>Arthurian Scout</h1>
    </div>
    <div class="controls">
      <button class="btn" id="clipperBtn" onclick="toggleClipper()">
        <span class="material-symbols-rounded">content_paste</span>
        <span id="clipperText">Start Clipper</span>
      </button>
      <button class="btn btn-primary" id="verifyBtn" onclick="startVerify()">
        <span class="material-symbols-rounded">verified</span>
        <span id="verifyText">Verify All</span>
      </button>
      <button class="btn" id="dmAllBtn" onclick="sendDMAll()" style="background:#8B5CF6;border-color:#8B5CF6;color:white;">
        <span class="material-symbols-rounded">send</span>
        <span id="dmAllText">DM All</span>
      </button>
      <button class="btn" onclick="clearAll()">
        <span class="material-symbols-rounded">delete</span>
      </button>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-dot pending"></div>
      <span class="stat-label">Pending</span>
      <span class="stat-value" id="countPending">0</span>
    </div>
    <div class="stat">
      <div class="stat-dot available"></div>
      <span class="stat-label">Available</span>
      <span class="stat-value" id="countAvailable">0</span>
    </div>
    <div class="stat">
      <div class="stat-dot unavailable"></div>
      <span class="stat-label">Unavailable</span>
      <span class="stat-value" id="countUnavailable">0</span>
    </div>
    <div class="stat">
      <div class="stat-dot dm-sent"></div>
      <span class="stat-label">DM Sent</span>
      <span class="stat-value" id="countDMSent">0</span>
    </div>
  </div>

  <main>
    <div class="creator-grid" id="creatorGrid"></div>
  </main>

  <script>
    let isClipperRunning = false;
    let isVerifying = false;
    let isDMRunning = false;
    let dmSentIds = new Set();

    // Toast notification
    function showToast(msg) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    // Copy to clipboard
    function copyId(id) {
      navigator.clipboard.writeText(id);
      showToast(`Copied: @${id}`);
    }

    // Copy Korean message
    function copyKR(id, nickname) {
      const name = nickname || id;
      const text = `[크리에이터 제안]
안녕하세요, 아서리안 스튜디오 입니다.
저희는 딱 10명의 잠재성을 지닌 크리에이터를 발굴하여 팀을 꾸려가고 있는데요!

저희는 파트너 크리에이터분들께
• 브랜드 상품 매칭
• 정산금 보너스
• 시청자 유입 / 성장 지원
등을 지원해드리고 있습니다!

${name}님께 참여를 제안드려보고 싶어서 안내 드립니다.
관심 있으시면 편하게 답장 부탁드립니다 : )

공식 홈페이지: https://www.arthrian.cloud/`;
      navigator.clipboard.writeText(text);
      showToast('Korean message copied!');
    }

    // Copy English message
    function copyEN(id, nickname) {
      const name = nickname || id;
      const text = `[Arthurian Studio]
Hello ${name}, we'd like to invite you to our exclusive creator team.

We support our partner creators with:
• Brand product matching
• Revenue bonus
• Audience growth support

If interested, feel free to reply!

Official website: https://www.arthrian.cloud/`;
      navigator.clipboard.writeText(text);
      showToast('English message copied!');
    }

    // Delete creator
    async function deleteCreator(id, status) {
      const endpoint = status === 'pending' ? `/pending/${id}` : `/verified/${id}`;
      await fetch(endpoint, { method: 'DELETE' });
      loadCreators();
    }

    // Render creators
    function renderCreators(creators) {
      const grid = document.getElementById('creatorGrid');

      if (!creators.length) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <span class="material-symbols-rounded">person_search</span>
            <p>No creators yet</p>
            <small>Start Clipper and copy TikTok URLs to add creators</small>
          </div>
        `;
        return;
      }

      grid.innerHTML = creators.map(c => {
        const statusClass = c.status;
        const statusText = c.status === 'pending' ? 'Pending' :
                          c.status === 'available' ? 'Available' : 'Unavailable';

        return `
          <div class="card ${statusClass}">
            <div class="card-header">
              <div class="card-id" onclick="copyId('${c.id}')">
                @${c.id}
                <span class="material-symbols-rounded">content_copy</span>
              </div>
              <span class="card-status ${statusClass}">${statusText}</span>
            </div>
            ${c.nickname ? `<div class="card-nickname" style="font-size:0.9rem;color:var(--text-muted);margin-bottom:8px;">${c.nickname}</div>` : ''}
            ${c.reason ? `<div class="card-reason">${c.reason}</div>` : ''}
            <div class="card-actions">
              <button class="btn btn-sm" onclick="window.open('https://www.tiktok.com/@${c.id}', '_blank')">
                <span class="material-symbols-rounded" style="font-size:14px">person</span> Profile
              </button>
              ${c.status === 'available' ? `
                ${dmSentIds.has(c.id) ? `
                  <button class="btn btn-sm" disabled style="opacity:0.6;background:#8B5CF6;border-color:#8B5CF6;color:white;">
                    <span class="material-symbols-rounded" style="font-size:14px">check</span> DM Sent
                  </button>
                ` : `
                  <button class="btn btn-sm" onclick="sendDM('${c.id}', '${c.nickname || ''}')" style="background:#8B5CF6;border-color:#8B5CF6;color:white;">
                    <span class="material-symbols-rounded" style="font-size:14px">send</span> Send DM
                  </button>
                `}
                <button class="btn btn-sm btn-success" onclick="copyKR('${c.id}', '${c.nickname || ''}')">KR</button>
                <button class="btn btn-sm" onclick="copyEN('${c.id}', '${c.nickname || ''}')">EN</button>
              ` : ''}
              <button class="btn btn-sm" onclick="deleteCreator('${c.id}', '${c.status}')">
                <span class="material-symbols-rounded" style="font-size:14px">close</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update stats
    function updateStats(creators) {
      const pending = creators.filter(c => c.status === 'pending').length;
      const available = creators.filter(c => c.status === 'available').length;
      const unavailable = creators.filter(c => c.status === 'unavailable').length;

      document.getElementById('countPending').textContent = pending;
      document.getElementById('countAvailable').textContent = available;
      document.getElementById('countUnavailable').textContent = unavailable;

      // Update verify button
      const verifyBtn = document.getElementById('verifyBtn');
      verifyBtn.disabled = pending === 0;
    }

    // Load creators from API
    async function loadCreators() {
      try {
        const res = await fetch('/creators');
        const data = await res.json();
        renderCreators(data.creators || []);
        updateStats(data.creators || []);
      } catch (e) {
        console.error('Failed to load creators:', e);
      }
    }

    // Toggle clipper
    async function toggleClipper() {
      const endpoint = isClipperRunning ? '/clipper/stop' : '/clipper/start';
      await fetch(endpoint, { method: 'POST' });
      checkStatus();
    }

    // Start verification
    async function startVerify() {
      if (isVerifying) return;

      const res = await fetch('/verify', { method: 'POST' });
      const data = await res.json();

      if (data.status === 'success') {
        showToast('Verification started...');
        isVerifying = true;
        updateVerifyButton();
      } else {
        showToast(data.message || 'Error');
      }
    }

    // Clear all
    async function clearAll() {
      if (!confirm('Clear all creators?')) return;
      await fetch('/clear', { method: 'POST' });
      loadCreators();
      showToast('Cleared all');
    }

    // Send DM to single creator
    async function sendDM(id, nickname) {
      showToast(`Sending DM to @${id}...`);
      try {
        const res = await fetch('/dm/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, nickname, lang: 'kr' })
        });
        const data = await res.json();
        if (data.status === 'success') {
          showToast(`DM process started for @${id}`);
        } else {
          showToast(data.message || 'DM failed');
        }
      } catch (e) {
        showToast('DM request failed');
      }
    }

    // Send DM to all available creators
    async function sendDMAll() {
      if (isDMRunning) {
        showToast('DM is already running');
        return;
      }

      if (!confirm('Send DM to all available creators?')) return;

      try {
        const res = await fetch('/dm/send-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lang: 'kr' })
        });
        const data = await res.json();
        if (data.status === 'success') {
          showToast(data.message);
          isDMRunning = true;
          updateDMButton();
        } else {
          showToast(data.message || 'DM All failed');
        }
      } catch (e) {
        showToast('DM All request failed');
      }
    }

    // Update DM button
    function updateDMButton() {
      const btn = document.getElementById('dmAllBtn');
      const text = document.getElementById('dmAllText');

      if (isDMRunning) {
        text.innerHTML = '<div class="spinner"></div> Sending...';
      } else {
        text.textContent = 'DM All';
      }
    }

    // Update clipper button
    function updateClipperButton() {
      const btn = document.getElementById('clipperBtn');
      const text = document.getElementById('clipperText');

      if (isClipperRunning) {
        btn.classList.add('active');
        text.textContent = 'Clipper Running';
      } else {
        btn.classList.remove('active');
        text.textContent = 'Start Clipper';
      }
    }

    // Update verify button
    function updateVerifyButton() {
      const btn = document.getElementById('verifyBtn');
      const text = document.getElementById('verifyText');

      if (isVerifying) {
        text.innerHTML = '<div class="spinner"></div> Verifying...';
      } else {
        text.textContent = 'Verify All';
      }
    }

    // Check status
    async function checkStatus() {
      try {
        const [clipperRes, verifyRes, dmRes] = await Promise.all([
          fetch('/clipper/status'),
          fetch('/verify/status'),
          fetch('/dm/status')
        ]);

        const clipperData = await clipperRes.json();
        const verifyData = await verifyRes.json();
        const dmData = await dmRes.json();

        isClipperRunning = clipperData.running;
        const wasVerifying = isVerifying;
        isVerifying = verifyData.running;

        const wasDMRunning = isDMRunning;
        isDMRunning = dmData.running;

        // Update DM sent IDs
        dmSentIds = new Set((dmData.sent || []).map(s => s.id));
        document.getElementById('countDMSent').textContent = dmSentIds.size;

        // Reload if verification just finished
        if (wasVerifying && !isVerifying) {
          loadCreators();
          showToast('Verification complete!');
        }

        // Reload if DM just finished
        if (wasDMRunning && !isDMRunning) {
          loadCreators();
          showToast('DM batch complete!');
        }

        updateClipperButton();
        updateVerifyButton();
        updateDMButton();
      } catch (e) {
        console.error('Status check failed:', e);
      }
    }

    // Initialize
    loadCreators();
    checkStatus();
    setInterval(loadCreators, 2000);
    setInterval(checkStatus, 1500);
  </script>
</body>
</html>
