<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Arthurian Scout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    :root {
      --bg-main: #0B0E14;
      --bg-card: #151A23;
      --bg-card-hover: #1E232F;
      --accent: #6366F1;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
      --text-main: #F3F4F6;
      --text-muted: #9CA3AF;
      --border: rgba(255,255,255,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
    }

    /* Header */
    header {
      background: rgba(11,14,20,0.95);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), #EC4899);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .brand h1 {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover {
      background: var(--bg-card-hover);
      color: var(--text-main);
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    .btn-primary:hover { background: #5558E6; }
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    .btn.active {
      background: rgba(16,185,129,0.15);
      color: var(--success);
      border-color: rgba(16,185,129,0.3);
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 24px;
      padding: 20px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(21,26,35,0.5);
    }
    .stat {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
    }
    .stat-dot.pending { background: var(--text-muted); }
    .stat-dot.available { background: var(--success); }
    .stat-dot.unavailable { background: var(--error); }
    .stat-label { color: var(--text-muted); font-size: 0.85rem; }
    .stat-value { font-weight: 600; font-size: 1.1rem; }

    /* Main Content */
    main {
      padding: 24px 32px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Creator Grid */
    .creator-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    /* Creator Card */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .card:hover {
      border-color: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 4px; height: 100%;
      background: var(--text-muted);
    }
    .card.pending::before { background: var(--text-muted); }
    .card.available::before { background: var(--success); }
    .card.available {
      border-color: rgba(16,185,129,0.3);
      background: linear-gradient(90deg, rgba(16,185,129,0.05), transparent);
    }
    .card.unavailable::before { background: var(--error); }
    .card.unavailable { opacity: 0.7; }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .card-id {
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-id:hover { color: var(--accent); }
    .card-id .material-symbols-rounded {
      font-size: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .card-id:hover .material-symbols-rounded { opacity: 1; }

    .card-status {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .card-status.pending {
      background: rgba(156,163,175,0.15);
      color: var(--text-muted);
    }
    .card-status.available {
      background: rgba(16,185,129,0.15);
      color: var(--success);
    }
    .card-status.unavailable {
      background: rgba(239,68,68,0.15);
      color: var(--error);
    }

    .card-reason {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: var(--text-muted);
    }
    .empty-state .material-symbols-rounded {
      font-size: 64px;
      opacity: 0.3;
      margin-bottom: 16px;
    }
    .empty-state p {
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    .empty-state small {
      opacity: 0.7;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: #1F2937;
      color: white;
      padding: 12px 24px;
      border-radius: 99px;
      font-size: 0.9rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    /* Loading Spinner */
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-icon">
        <span class="material-symbols-rounded" style="color:white">radar</span>
      </div>
      <h1>Arthurian Scout</h1>
    </div>
    <div class="controls">
      <button class="btn" id="clipperBtn" onclick="toggleClipper()">
        <span class="material-symbols-rounded">content_paste</span>
        <span id="clipperText">Start Clipper</span>
      </button>
      <button class="btn btn-primary" id="verifyBtn" onclick="startVerify()">
        <span class="material-symbols-rounded">verified</span>
        <span id="verifyText">Verify All</span>
      </button>
      <button class="btn" onclick="clearAll()">
        <span class="material-symbols-rounded">delete</span>
      </button>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat">
      <div class="stat-dot pending"></div>
      <span class="stat-label">Pending</span>
      <span class="stat-value" id="countPending">0</span>
    </div>
    <div class="stat">
      <div class="stat-dot available"></div>
      <span class="stat-label">Available</span>
      <span class="stat-value" id="countAvailable">0</span>
    </div>
    <div class="stat">
      <div class="stat-dot unavailable"></div>
      <span class="stat-label">Unavailable</span>
      <span class="stat-value" id="countUnavailable">0</span>
    </div>
  </div>

  <main>
    <div class="creator-grid" id="creatorGrid"></div>
  </main>

  <script>
    let isClipperRunning = false;
    let isVerifying = false;

    // Toast notification
    function showToast(msg) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    // Copy to clipboard
    function copyId(id) {
      navigator.clipboard.writeText(id);
      showToast(`Copied: @${id}`);
    }

    // Copy Korean message
    function copyKR(id) {
      const text = `[크리에이터 제안]
안녕하세요, 아서리안 스튜디오 입니다.
저희는 딱 10명의 잠재성을 지닌 크리에이터를 발굴 하여 팀을 꾸려가고 있는데요!

${id}님께 참여를 제안드려보고 싶어서 안내 드립니다.

아서리안만의 특별 인센티브나 채널 성장에 대해 대화 나눠보시면 좋을듯 합니다 : )

공식 홈페이지 주소입니다 ! - https://www.arthrian.cloud/benefit`;
      navigator.clipboard.writeText(text);
      showToast('Korean message copied!');
    }

    // Copy English message
    function copyEN(id) {
      const text = `[Arthurian Studio]
Hello ${id}, we'd like to invite you to our exclusive creator team.
Check our benefits: https://www.arthrian.cloud/benefit`;
      navigator.clipboard.writeText(text);
      showToast('English message copied!');
    }

    // Delete creator
    async function deleteCreator(id, status) {
      const endpoint = status === 'pending' ? `/pending/${id}` : `/verified/${id}`;
      await fetch(endpoint, { method: 'DELETE' });
      loadCreators();
    }

    // Render creators
    function renderCreators(creators) {
      const grid = document.getElementById('creatorGrid');

      if (!creators.length) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <span class="material-symbols-rounded">person_search</span>
            <p>No creators yet</p>
            <small>Start Clipper and copy TikTok URLs to add creators</small>
          </div>
        `;
        return;
      }

      grid.innerHTML = creators.map(c => {
        const statusClass = c.status;
        const statusText = c.status === 'pending' ? 'Pending' :
                          c.status === 'available' ? 'Available' : 'Unavailable';

        return `
          <div class="card ${statusClass}">
            <div class="card-header">
              <div class="card-id" onclick="copyId('${c.id}')">
                @${c.id}
                <span class="material-symbols-rounded">content_copy</span>
              </div>
              <span class="card-status ${statusClass}">${statusText}</span>
            </div>
            ${c.nickname ? `<div class="card-nickname" style="font-size:0.9rem;color:var(--text-muted);margin-bottom:8px;">${c.nickname}</div>` : ''}
            ${c.reason ? `<div class="card-reason">${c.reason}</div>` : ''}
            <div class="card-actions">
              <button class="btn btn-sm" onclick="window.open('https://www.tiktok.com/@${c.id}', '_blank')">
                <span class="material-symbols-rounded" style="font-size:14px">person</span> Profile
              </button>
              ${c.status === 'available' ? `
                <button class="btn btn-sm btn-success" onclick="copyKR('${c.id}')">Copy KR</button>
                <button class="btn btn-sm" onclick="copyEN('${c.id}')">Copy EN</button>
              ` : ''}
              <button class="btn btn-sm" onclick="deleteCreator('${c.id}', '${c.status}')">
                <span class="material-symbols-rounded" style="font-size:14px">close</span>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update stats
    function updateStats(creators) {
      const pending = creators.filter(c => c.status === 'pending').length;
      const available = creators.filter(c => c.status === 'available').length;
      const unavailable = creators.filter(c => c.status === 'unavailable').length;

      document.getElementById('countPending').textContent = pending;
      document.getElementById('countAvailable').textContent = available;
      document.getElementById('countUnavailable').textContent = unavailable;

      // Update verify button
      const verifyBtn = document.getElementById('verifyBtn');
      verifyBtn.disabled = pending === 0;
    }

    // Load creators from API
    async function loadCreators() {
      try {
        const res = await fetch('/creators');
        const data = await res.json();
        renderCreators(data.creators || []);
        updateStats(data.creators || []);
      } catch (e) {
        console.error('Failed to load creators:', e);
      }
    }

    // Toggle clipper
    async function toggleClipper() {
      const endpoint = isClipperRunning ? '/clipper/stop' : '/clipper/start';
      await fetch(endpoint, { method: 'POST' });
      checkStatus();
    }

    // Start verification
    async function startVerify() {
      if (isVerifying) return;

      const res = await fetch('/verify', { method: 'POST' });
      const data = await res.json();

      if (data.status === 'success') {
        showToast('Verification started...');
        isVerifying = true;
        updateVerifyButton();
      } else {
        showToast(data.message || 'Error');
      }
    }

    // Clear all
    async function clearAll() {
      if (!confirm('Clear all creators?')) return;
      await fetch('/clear', { method: 'POST' });
      loadCreators();
      showToast('Cleared all');
    }

    // Update clipper button
    function updateClipperButton() {
      const btn = document.getElementById('clipperBtn');
      const text = document.getElementById('clipperText');

      if (isClipperRunning) {
        btn.classList.add('active');
        text.textContent = 'Clipper Running';
      } else {
        btn.classList.remove('active');
        text.textContent = 'Start Clipper';
      }
    }

    // Update verify button
    function updateVerifyButton() {
      const btn = document.getElementById('verifyBtn');
      const text = document.getElementById('verifyText');

      if (isVerifying) {
        text.innerHTML = '<div class="spinner"></div> Verifying...';
      } else {
        text.textContent = 'Verify All';
      }
    }

    // Check status
    async function checkStatus() {
      try {
        const [clipperRes, verifyRes] = await Promise.all([
          fetch('/clipper/status'),
          fetch('/verify/status')
        ]);

        const clipperData = await clipperRes.json();
        const verifyData = await verifyRes.json();

        isClipperRunning = clipperData.running;
        const wasVerifying = isVerifying;
        isVerifying = verifyData.running;

        // Reload if verification just finished
        if (wasVerifying && !isVerifying) {
          loadCreators();
          showToast('Verification complete!');
        }

        updateClipperButton();
        updateVerifyButton();
      } catch (e) {
        console.error('Status check failed:', e);
      }
    }

    // Initialize
    loadCreators();
    checkStatus();
    setInterval(loadCreators, 2000);
    setInterval(checkStatus, 1500);
  </script>
</body>
</html>
